import { SupabaseService } from '../services/supabase.js';
import { ERROR_CODES } from '../constants/error-codes.js';
import { EventTracker } from '../services/event-tracker.js';

/**
 * AUTOMATION: Calendar Entry Deletion
 *
 * Triggers: When a calendar entry is deleted in Clio
 *
 * Process:
 * 1. Get calendar entry ID from webhook
 * 2. Delete calendar entry record from Supabase
 * 3. Note: Tasks are NOT deleted - they remain and can be regenerated by stage automation
 */

export class CalendarEntryDeletedAutomation {
  /**
   * Main entry point for calendar entry deletion
   *
   * @param {Object} webhookData - The webhook payload from Clio
   * @param {string} [traceId] - Optional trace ID for event tracking
   */
  static async process(webhookData, traceId = null) {
    const calendarEntryId = webhookData.data.id;

    console.log(`[CALENDAR-DELETE] ${calendarEntryId} Processing deletion...`);

    // Step: Idempotency check
    const idempotencyStepId = await EventTracker.startStep(traceId, {
      layerName: 'processing',
      stepName: 'idempotency_check',
      metadata: { calendarEntryId },
    });

    const idempotencyKey = SupabaseService.generateIdempotencyKey(
      'calendar_entry.deleted',
      calendarEntryId,
      webhookData.data.deleted_at || webhookData.occurred_at
    );

    const existing = await SupabaseService.checkWebhookProcessed(idempotencyKey);
    if (existing) {
      if (existing.success === null) {
        console.log(`[CALENDAR-DELETE] ${calendarEntryId} Still processing (concurrent request)`);
        await EventTracker.endStep(idempotencyStepId, { status: 'skipped', metadata: { reason: 'still_processing' } });
        return {
          success: null,
          action: 'still_processing',
          processing_started_at: existing.created_at,
        };
      }

      console.log(`[CALENDAR-DELETE] ${calendarEntryId} Already processed at ${existing.processed_at}`);
      await EventTracker.endStep(idempotencyStepId, { status: 'skipped', metadata: { reason: 'already_processed' } });
      return {
        success: existing.success,
        action: existing.action,
        processed_at: existing.processed_at,
        cached: true,
      };
    }

    await EventTracker.endStep(idempotencyStepId, { status: 'success' });

    // Step 0.5: Reserve webhook immediately
    await SupabaseService.recordWebhookProcessed({
      idempotency_key: idempotencyKey,
      webhook_id: webhookData.id,
      event_type: 'calendar_entry.deleted',
      resource_type: 'calendar_entry',
      resource_id: calendarEntryId,
      success: null, // NULL = processing
      action: 'processing',
      webhook_payload: webhookData,
    });

    const startTime = Date.now();

    try {
      // Step: Process deletion
      const processStepId = await EventTracker.startStep(traceId, {
        layerName: 'automation',
        stepName: 'process_deletion',
        metadata: { calendarEntryId },
      });

      // Note: We don't delete from 'meetings' table - only track deletion
      console.log(`[CALENDAR-DELETE] ${calendarEntryId} Deleting calendar entry record from Supabase`);

      // For now, we just log it - calendar entries may not have a separate table
      // Tasks with this calendar_entry_id remain in the database
      console.log(`[CALENDAR-DELETE] ${calendarEntryId} Calendar entry deleted in Clio`);
      console.log(`[CALENDAR-DELETE] ${calendarEntryId} Tasks with this calendar_entry_id will remain in database`);

      await EventTracker.endStep(processStepId, { status: 'success' });

      // Update webhook to success
      await SupabaseService.updateWebhookProcessed(idempotencyKey, {
        processing_duration_ms: Date.now() - startTime,
        success: true,
        action: 'calendar_entry_deleted',
      });

      console.log(`[CALENDAR-DELETE] ${calendarEntryId} COMPLETED\n`);
      return { success: true, action: 'calendar_entry_deleted' };

    } catch (error) {
      console.error(`[CALENDAR-DELETE] ${calendarEntryId} ERROR: ${error.message}`);

      // Log error
      await SupabaseService.logError(
        ERROR_CODES.AUTOMATION_FAILED,
        `Calendar entry deletion failed: ${error.message}`,
        {
          calendar_entry_id: calendarEntryId,
          webhook_id: webhookData.id,
          error: error.message,
          stack: error.stack,
        }
      );

      // Update webhook to failure
      await SupabaseService.updateWebhookProcessed(idempotencyKey, {
        processing_duration_ms: Date.now() - startTime,
        success: false,
        action: 'error',
      });

      throw error;
    }
  }
}
