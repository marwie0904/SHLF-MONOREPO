/**
 * Test if tasks are being generated by the automation
 */

import { ClioService } from './src/services/clio.js';
import { createClient } from '@supabase/supabase-js';
import { config } from './src/config/index.js';

const supabase = createClient(config.supabase.url, config.supabase.key);
const TEST_MATTER_ID = 1675950832;

// Try a common Estate Planning stage that should have tasks
const TEST_STAGE_ID = 828078; // I/V MEETING stage

async function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function testTaskGeneration() {
  console.log('\nüß™ Testing Task Generation\n');
  console.log('='.repeat(60));

  try {
    // 1. Get current matter details
    console.log(`\nüìã Fetching current matter ${TEST_MATTER_ID} details...`);
    const matter = await ClioService.getMatter(TEST_MATTER_ID);
    console.log(`   Current stage: ${matter.matter_stage?.name || 'Unknown'} (${matter.matter_stage?.id || 'N/A'})`);
    console.log(`   Practice area: ${matter.practice_area?.name || 'Unknown'}`);
    console.log(`   Location: ${matter.custom_field_values?.find(f => f.field_name === 'Location')?.value || 'Unknown'}`);

    // 2. Move to test stage (skip location update for now)
    console.log(`\nüîÑ Moving matter to stage ${TEST_STAGE_ID} (I/V MEETING)...`);
    await ClioService.updateMatter(TEST_MATTER_ID, {
      matter_stage: { id: TEST_STAGE_ID }
    });
    console.log('   ‚úì Stage updated successfully');

    // 4. Wait for automation to process
    console.log(`\n‚è≥ Waiting 30 seconds for automation to process...`);
    await wait(30000);

    // 5. Check Supabase for tasks
    console.log(`\nüìã Checking Supabase for generated tasks...`);
    const { data: tasks, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('matter_id', TEST_MATTER_ID)
      .eq('stage_id', TEST_STAGE_ID);

    if (error) {
      console.error('   ‚ùå Error fetching tasks:', error);
      return;
    }

    console.log(`\n${'='.repeat(60)}`);
    if (tasks && tasks.length > 0) {
      console.log(`‚úÖ SUCCESS! Found ${tasks.length} tasks generated\n`);

      tasks.forEach((task, index) => {
        console.log(`Task ${index + 1}:`);
        console.log(`   Number: ${task.task_number}`);
        console.log(`   Name: ${task.task_name}`);
        console.log(`   Assigned User: ${task.assigned_user}`);
        console.log(`   Due Date: ${task.due_date || 'None'}`);
        console.log(`   Task ID: ${task.task_id}`);
        console.log('');
      });
    } else {
      console.log('‚ùå NO TASKS GENERATED\n');
      console.log('Possible reasons:');
      console.log('   1. Automation server is not running');
      console.log('   2. No task templates configured for this stage');
      console.log('   3. Webhook not firing or not being processed');
      console.log('');
    }

    console.log('‚úÖ Test completed\n');

  } catch (error) {
    console.error('\n‚ùå Test failed:', error.message);
    console.error(error.stack);
  }
}

testTaskGeneration();
